<!doctype html>
<html>

<head>
	<title>Bubble Chart</title>
	<script src="/Chart.min.js"></script>
	<style type="text/css">
		canvas{
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
        body { 
            background-color: #cccccc;
            font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
            font-weight: 500; 
            font-size: 14px; 
            color: #1e1e1e; /* dark gray */ 
        }
	</style>
</head>

<body>
	<div id="container" style="width: 100%;">
        <div id="message"></div> 
        <canvas id="canvas"></canvas>
        <div id="search-box">
            Search <input type="text" id="search-term"/><button id="search-button">Go</button></div>
        </div>
	</div>
	<script>

        var colors = [
            "rgba(44, 19, 32, 1)",
            "rgba(95, 75, 102, 1)",
            "rgba(167, 173, 198, 1)",
            "rgba(135, 151, 175, 1)",
            "rgba(86, 102, 122, 1)",
        ];
        var fetch, data_labels;
        document.getElementById('canvas').onclick = function(evt) {
            var activePoints = window.reddit_graph.getElementsAtEvent(evt);
            if(activePoints.length) {
                fetch_graph("r/" + activePoints[0]._model.label);
            }
        }
        document.getElementById("search-button").onclick = function(evt) {
            fetch_graph("r/" + document.getElementById('search-term').value);
        }
        document.getElementById("search-term").addEventListener("keyup", function(evt) {
            if (event.keyCode === 13) {
                fetch_graph("r/" + document.getElementById('search-term').value);
            }
        });

        var get_relevant_search_from_address = function() {
            var remove_proto = window.location.href.replace("http://", "");
            var first_slash = remove_proto.indexOf("/") +1;
            return remove_proto.substr(first_slash, remove_proto.length - first_slash); 
        }
        var create_url_from_search = function(search) {
            return "http://localhost:3000/" + search;
        }
        var display_message = function(input) {
            document.getElementById('message').innerHTML = "<h1>" + input + "</h1>";
        }

        var colorChart = function(chart) {
            var dataSet = chart.config.data.datasets[0];
            dataSet.backgroundColor = [];
            for(var i=0; i<dataSet.data.length; i++) {
                var color = "blue";
                var m = i%3;
                if(m == 0) {
                    color = "green";
                }
                else if(m==1) {
                    color = "red";
                }
                dataSet.backgroundColor.push(colors[i%colors.length]);
            }
            chart.update();
        }

        var fetch_graph = function(search) {

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    try {
                        var resp = JSON.parse(this.response);
                        if(resp.message !== undefined) {
                            display_message(resp.message);
                        }
                        if(resp.chart) {
                            data_labels = resp.chart.data.labels
                            var ctx = document.getElementById('canvas').getContext('2d');
                            window.reddit_graph = new Chart(ctx, resp.chart);
                            
                            colorChart(window.reddit_graph);
                        }
                    }
                    catch (err) {
                        display_message(search + " not found");
                    }
                }
            };
            fetch = search;
            var url = create_url_from_search(search);
            window.history.pushState(undefined, "Title", url);
            display_message("Fetching " + search);
            xhttp.open("GET", url+".json", true);
            xhttp.send();
        }

		window.onload = function() {
            fetch_graph(get_relevant_search_from_address(window.location.href));
		};

	</script>
</body>

</html>